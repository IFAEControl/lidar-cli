\documentclass[letterpaper, 10 pt]{article}
\pagenumbering{Roman}

\usepackage[margin=1.25in]{geometry}
\usepackage{color}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{authblk}
\usepackage{parskip}
\usepackage{listings}
\usepackage[dvipsnames]{xcolor}
\usepackage[english]{babel}
\usepackage{framed}

\hypersetup{
    colorlinks,
    linktoc=all,
    citecolor=black,
    filecolor=black,
    linkcolor=black,
    urlcolor=black
}

\makeatletter

\definecolor{light-gray}{gray}{0.88}
\lstset{ 
			backgroundcolor=\color{light-gray},
			xleftmargin=.25in,
} 

% switch to key style at EOL
\lst@AddToHook{EveryLine}{\ifx\lst@language\language@yaml\YAMLkeystyle\fi}
\makeatother

\newcommand\ProcessThreeDashes{\llap{\color{cyan}\mdseries-{-}-}}


\begin{document}
\title{LIDAR CLI User Manual}
\author{David Roman \\  \href{mailto:droman@ifae.es}{droman@ifae.es} }
\affil{IFAE}
\maketitle
\pagestyle{empty}
\newpage
\tableofcontents
\newpage
\pagenumbering{arabic}
\pagestyle{plain}

\section{Running licli}
\subsection{First steps}
To be able to run licli the first step is to specify the IP address of the server. This is done by defining LIDAR\_ADDR environment variable. For example if the server is running in the local host we can \emph{export LIDAR\_ADDR="127.0.0.1"}\\
\linebreak
If it's the first time we run licli it would ask us to introduce a password. This password is defined in the configuration file of the lidar server software. 
In case that it's not the first time and jwt secret has changed we can have some errors like \textbf{"The Token's Signature resulted invalid when verified using the Algorithm"}. If it's the case remove \textit{\~{}/.cache/lidar/0.1/token} and try again.\\

\subsection{Examples}

Open doors: \textbf{./licli motors doors \texttt{-{}-}open=1}\\
Get converted sensors values: \textbf{./licli llc sensors}\\
Make 4 shots with disc level 2: \textbf{./licli operation acq \texttt{-{}-}shots=4 \texttt{-{}-}disc=2}. Output data will be in \textit{\~{}/.local/share/lidar/0.1}.

\section{Commands reference}
Commands marked as \textbf{debug} are commands used for debugging purposes.\\
\linebreak
Unless other commands, operation commands (\ref{operationcmds}) are complex commands. Those complex commands can be macros (ie: a couple of commands executed sequentially) or control functions which makes use of the other functions.
\subsection{LLC}
This command contains all the commands related with the low level control board.
\subsubsection{Arms}
Command to control and monitor the laser arm. Only one action will be executed at a time. If more than one action is specified, only one will be executed, other will be ignored.
\begin{itemize}
	\item check-node (\textbf{debug}): Check communication with node N (N must be either "1" or "2")
	\item emergency-stop (\textbf{debug}): Execute emergency stop
	\item get-pos: Get current position
	\item go: Go to current position. Argument must follow the format X:Y (eg: 1000:10000)
	\item init: Initialize arm
	\item set-speed (\textbf{debug}): Set speed. Argument must follow the format Axis:speed.
\end{itemize}
\subsubsection{DAC}
Control dac voltages.
\begin{itemize}
	\item set-voltage: Set dac voltage. Argument must follow the format dac:voltage (0:100).
\end{itemize}

\subsubsection{Drivers}
Get information about the drivers
\begin{itemize}
	\item get-status: Get a list of drivers status
\end{itemize}

\subsubsection{Hotwind}
Controls the hotwind. Only one action will be executed at a time. If more than one action is specified, only one will be executed, other will be ignored.
\begin{itemize}
	\item error (\textbf{debug}): Set error Â¿?
	\item lock (\textbf{debug}): Lock
	\item unlock (\textbf{debug}): Unlock
\end{itemize}

\subsubsection{Laser}
Commands to control the laser. Only one action will be executed at a time. If more than one action is specified, only one will be executed, other will be ignored.
\begin{itemize}
	\item check (\textbf{debug}): Check laser communication
	\item fire: Fire the laser
	\item get-temp: Get laser temperature. If the laser is not powered it returns the last value, it doesn't return an error.
	\item init: Initialize laser
	\item pause: Pause the laser
	\item power: Set power in \%
	\item stop: Stop the laser
\end{itemize}

\subsubsection{Relay}
Commands to switch on/off relays. Only one action will be executed at a time. If more than one action is specified, only one will be executed, other will be ignored.
\begin{itemize}
	\item get-status: Get status
	\item hotwind-off: Disable hotwind
	\item hotwind-on: Enable hotwind
	\item laser-on: Enable laser
	\item laser-off: Disable laser
	\item licel-on: Enable laser
	\item licel-off: Disable laser
	\item get-status: Get relay status
	\item set-status: Set relay status. Argument must follow the format idx:status where status is true or false (eg: 0:false)
\end{itemize}

\subsubsection{Sensors}
Commands to get sensor information from low level control board. There are other sensors that this command doesn't read, for example the temperature of the head of the laser.\\
If no option is specified it will print values in human readable form.
\begin{itemize}
	\item raw (\textbf{debug}): Get raw sensor values
\end{itemize}

\subsection{Motors}
\subsubsection{Doors}
\begin{itemize}
	\item close: With an argument which must be "0" or "1". "1" to start closing the doors, "0" to stop the movement.
	\item open: With an argument which must be "0" or "1". "1" to start opening the doors, "0" to stop the movement.
	\item status: Print current status of the doors (OPEN, CLOSE or INTERSTATE if it's something in the middle)
\end{itemize}
\subsubsection{Petals}
\begin{itemize}
	\item close: With an argument which must be "0" or "1". "1" to start closing the petals, "0" to stop the movement.
	\item open: With an argument which must be "0" or "1". "1" to start opening the petals, "0" to stop the movement.
	\item status: Print current status of the petals (CLOSED or UNKNOWN if there is something else)
\end{itemize}
\subsubsection{Telescope}
\begin{itemize}
	\item ga: Get current azimuth position
	\item gz: Get current zenith position
	\item home: Go home. If tries to go to the position registered before opening the doors, if it's not possible it defaults to the hardcoded values, which may not be the correct ones. For this reason it's important to start the server when the doors are closed.
	\item sa: Go to the given azimuth encoder position (an unsigned integer)
	\item sz: Go to the given zenith encoder position (an unsigned integer)
\end{itemize}
\subsection{Monitoring}
Monitoring commands
\subsubsection{Sensors}
Monitoring of sensors. 
\begin{itemize}
	\item humidity: Show readings of humidity values 
	\item env-temperature: Show readings of environment temperatures
	\item last-value (can be used in combination): Show the last value reading
\end{itemize}
\subsubsection{Motors}
Monitoring of the motor monitoring board. Currently it only prints the encoders position.

\subsection{Alarms}
Waits for alarm messages. Alarms are triggered whenever a sensor exceeds the safe limit. Message are sent in the form of strings informing of the problem.

\subsection{Config}
Returns current configuration of the server.

\subsection{Trace}
Command for debugging purposes

\subsection{Operation} \label{operationcmds}
\subsubsection{Acquisition}
When taking an acquisition by default the data is stored in the licel format in the server HDD. The server by default gives us a file ID of the file of the acquisition. After that if we want we can use that ID to download the file. Files are not download automatically.
\begin{itemize}
	\item disc: Discriminator level. Always required.
	\item download: Download licel file. Argument is the ID (unsigned integer) of the licel file we want to download.
	\item shots: Acquire a given number of shots. Argument is an unsigned integer greater than 1. 
	\item start: Start acquisition manually
	\item stop: Stop acquisition
	\item analog-data: Save a file with all analog values using space character as separator.
\end{itemize}
\subsubsection{Telescope}
Telescope motors operations. When going to parking position it will first try to go to the last know good value (ie: the position we know that doors can be closed), if it's not possible it will go to the hardcoded values.
\begin{itemize}
	\item get-azimuth: Get azimuth position
	\item go-azimuth-parking: Go to azimuth parking position
	\item go-parking: Go to parking position
	\item go-zenith-parking: Go zenith parking position
	\item start-test: Execute telescope tests (move azmiuth and zenith to their maximum, minimum and parking position).
	\item stop: Stop any telescope movement
	\item to-max-azimuth: Go to maximum azimuth
	\item to-max-zenith: Go to maximum zenith
	\item to-min-azimuth: Go to minimum azimuth		
\end{itemize}
\subsubsection{Low level}
Low level operations
\begin{itemize}
	\item arm-align: Move arm to alignment position (first it must be initialized)
	\item arm-init: Initialize arm
	\item laser-init: Initialize laser (first it must be powered-on)
	\item laser-power-off: Power off laser
	\item laser-power-on Power on laser
	\item micro-init: Micro initialization sequence. Prepare laser, arm and rump up all DACs
	\item micro-shutdown: Micro shutdown sequence. Power off laser hotwind and ramp down DACs
	\item ramp-down: Ramp down all DACs
	\item ramp-single: Modify voltage of a single DAC. Argument must follow the format idx:voltage.
	\item ramp-up: Ramp up all DACs
\end{itemize}

\section{Configuration}
Configuration files can be found on \textit{\~{}/.config/lidar/0.1/client/}. Currently there is only one file, micro\_init\_sequence.properties which can be used to defines arm alignment position, pmt voltages and temperature threshold at which the hotwind should be powered on.

\section{Troubleshooting}
In case of unknown problems, increase verbosity level to gather more information. To do this define \emph{LIDAR\_VERBOSITY} with an integer in the range of [1, 4].
\subsection{The Token's Signature resulted invalid...}
This happens when the cached token is not correct. To fix it simply remove \textit{\~{}/.cache/lidar/0.1/token} and try again. This way a new token will be generated.\\
\subsection{This method is not safe/read-only}
This means that the keylock is on which means that only those commands that don't produce side effects are allowed (ie: read-only commands) for example to read the status, etc. To fix it someone have to go physically and switch off the keylock.
\subsection{Where is X,Y,Z file/directory}
This program follow the XDG Base Directory specification. The full specification may be found on \url{https://standards.freedesktop.org/basedir-spec/basedir-spec-latest.html}\\
\linebreak
In short: config files are in \textit{ \~{}/.config/lidar}. Data is in \textit{\~{}/.local/share/lidar}. Cache content is in \textit{\~{}/.cache/lidar}.

\newpage

%\bibliography{}

\end{document}